[![Logo](https://docs.keeper.io/~gitbook/image?url=https%3A%2F%2F2557019839-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-
x-
prod.appspot.com%2Fo%2Fspaces%252FOthZEjvFH25YbgTBe0jT%252Flogo%252Fp7my2BdDymT53qZmRrq5%252FKeeper_600.png%3Falt%3Dmedia%26token%3D0a515169-d51f-4ca3-a458-f81394812492&width=260&dpr=4&quality=100&sign=ce896b6e&sv=2)![Logo](https://docs.keeper.io/~gitbook/image?url=https%3A%2F%2F2557019839-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-
x-
prod.appspot.com%2Fo%2Fspaces%252FOthZEjvFH25YbgTBe0jT%252Flogo%252Fqe0JYUjJDoQWioecglOW%252Fkeeper-
no-
tag.png%3Falt%3Dmedia%26token%3D29dff9f6-9c7e-41f4-80a3-e879ee78667c&width=260&dpr=4&quality=100&sign=1e0a5ac8&sv=2)](https://docs.keeper.io/en/keeperpam/)

Ask or search...

`Ctrl``K`

KeeperPAM and Secrets Manager

[Docs Home](https://docs.keeper.io/en/privileged-access-manager/password-
rotation/rotation-use-cases/aws/iam-user-access-key?fallback=true)[Keeper
Connection Manager](https://docs.keeper.io/en/keeper-connection-
manager/privileged-access-manager/password-rotation/rotation-use-
cases/aws/iam-user-access-key?fallback=true)[User
Guides](https://docs.keeper.io/en/user-guides/privileged-access-
manager/password-rotation/rotation-use-cases/aws/iam-user-access-
key?fallback=true)[Release Notes](https://docs.keeper.io/en/release-
notes/privileged-access-manager/password-rotation/rotation-use-cases/aws/iam-
user-access-key?fallback=true)[Enterprise
Guide](https://docs.keeper.io/en/enterprise-guide/privileged-access-
manager/password-rotation/rotation-use-cases/aws/iam-user-access-
key?fallback=true)[MSP Guide](https://docs.keeper.io/en/msp-guide/privileged-
access-manager/password-rotation/rotation-use-cases/aws/iam-user-access-
key?fallback=true)[SSO Connect Cloud](https://docs.keeper.io/en/sso-connect-
cloud/privileged-access-manager/password-rotation/rotation-use-cases/aws/iam-
user-access-key?fallback=true)[KeeperPAM and Secrets
Manager](https://docs.keeper.io/en/keeperpam/privileged-access-
manager/password-rotation/rotation-use-cases/aws/iam-user-access-
key?fallback=true)[SSO Connect On-Prem](https://docs.keeper.io/en/sso-connect-
on-prem/privileged-access-manager/password-rotation/rotation-use-
cases/aws/iam-user-access-key?fallback=true)[Keeper
Bridge](https://docs.keeper.io/en/keeper-bridge/privileged-access-
manager/password-rotation/rotation-use-cases/aws/iam-user-access-
key?fallback=true)

KeeperPAM and Secrets Manager

[Docs Home](https://docs.keeper.io/en/privileged-access-manager/password-
rotation/rotation-use-cases/aws/iam-user-access-key?fallback=true)[Keeper
Connection Manager](https://docs.keeper.io/en/keeper-connection-
manager/privileged-access-manager/password-rotation/rotation-use-
cases/aws/iam-user-access-key?fallback=true)[User
Guides](https://docs.keeper.io/en/user-guides/privileged-access-
manager/password-rotation/rotation-use-cases/aws/iam-user-access-
key?fallback=true)[Release Notes](https://docs.keeper.io/en/release-
notes/privileged-access-manager/password-rotation/rotation-use-cases/aws/iam-
user-access-key?fallback=true)[Enterprise
Guide](https://docs.keeper.io/en/enterprise-guide/privileged-access-
manager/password-rotation/rotation-use-cases/aws/iam-user-access-
key?fallback=true)[MSP Guide](https://docs.keeper.io/en/msp-guide/privileged-
access-manager/password-rotation/rotation-use-cases/aws/iam-user-access-
key?fallback=true)[SSO Connect Cloud](https://docs.keeper.io/en/sso-connect-
cloud/privileged-access-manager/password-rotation/rotation-use-cases/aws/iam-
user-access-key?fallback=true)[KeeperPAM and Secrets
Manager](https://docs.keeper.io/en/keeperpam/privileged-access-
manager/password-rotation/rotation-use-cases/aws/iam-user-access-
key?fallback=true)[SSO Connect On-Prem](https://docs.keeper.io/en/sso-connect-
on-prem/privileged-access-manager/password-rotation/rotation-use-
cases/aws/iam-user-access-key?fallback=true)[Keeper
Bridge](https://docs.keeper.io/en/keeper-bridge/privileged-access-
manager/password-rotation/rotation-use-cases/aws/iam-user-access-
key?fallback=true)

  * [Overview](/en/keeperpam)
  * Privileged Access Manager

    * [Setup Steps](/en/keeperpam/privileged-access-manager/setup-steps)
    * [Quick Start: Sandbox](/en/keeperpam/privileged-access-manager/quick-start-sandbox)
    * [Getting Started](/en/keeperpam/privileged-access-manager/getting-started)

      * [Architecture](/en/keeperpam/privileged-access-manager/getting-started/architecture)

        * [Architecture Diagram](/en/keeperpam/privileged-access-manager/getting-started/architecture/system-architecture)
        * [Vault Security](/en/keeperpam/privileged-access-manager/getting-started/architecture/vault-security)
        * [Router Security](/en/keeperpam/privileged-access-manager/getting-started/architecture/router-security)
        * [Gateway Security](/en/keeperpam/privileged-access-manager/getting-started/architecture/gateway-security)
        * [Connection and Tunnel Security](/en/keeperpam/privileged-access-manager/getting-started/architecture/connection-and-tunnel-security)

      * [KeeperPAM Licensing](/en/keeperpam/privileged-access-manager/getting-started/keeperpam-licensing)
      * [Enforcement Policies](/en/keeperpam/privileged-access-manager/getting-started/enforcement-policies)
      * [Vault Structure](/en/keeperpam/privileged-access-manager/getting-started/vault-structure)
      * [Record Linking](/en/keeperpam/privileged-access-manager/getting-started/record-linking)
      * [Applications](/en/keeperpam/privileged-access-manager/getting-started/applications)
      * [Devices](/en/keeperpam/privileged-access-manager/getting-started/devices)
      * [Gateways](/en/keeperpam/privileged-access-manager/getting-started/gateways)

        * [Creating a Gateway](/en/keeperpam/privileged-access-manager/getting-started/gateways/one-time-access-token)
        * [Docker Installation](/en/keeperpam/privileged-access-manager/getting-started/gateways/docker-installation)
        * [Linux Installation](/en/keeperpam/privileged-access-manager/getting-started/gateways/linux-installation)
        * [Windows Installation](/en/keeperpam/privileged-access-manager/getting-started/gateways/windows-installation)
        * [Auto Updater](/en/keeperpam/privileged-access-manager/getting-started/gateways/auto-updater)
        * [Alerts and SIEM Integration](/en/keeperpam/privileged-access-manager/getting-started/gateways/alerts-and-siem-integration)
        * [Advanced Configuration](/en/keeperpam/privileged-access-manager/getting-started/gateways/advanced-configuration)

          * [Gateway Configuration with AWS KMS](/en/keeperpam/privileged-access-manager/getting-started/gateways/advanced-configuration/gateway-configuration-with-aws-kms)
          * [Gateway Configuration with Custom Fields](/en/keeperpam/privileged-access-manager/getting-started/gateways/advanced-configuration/gateway-configuration-with-custom-fields)

      * [PAM Configuration](/en/keeperpam/privileged-access-manager/getting-started/pam-configuration)

        * [AWS Environment Setup](/en/keeperpam/privileged-access-manager/getting-started/pam-configuration/aws-environment-setup)
        * [Azure Environment Setup](/en/keeperpam/privileged-access-manager/getting-started/pam-configuration/azure-environment-setup)
        * [Local Environment Setup](/en/keeperpam/privileged-access-manager/getting-started/pam-configuration/local-environment-setup)

      * [PAM Resources](/en/keeperpam/privileged-access-manager/getting-started/pam-resources)

        * [PAM Machine](/en/keeperpam/privileged-access-manager/getting-started/pam-resources/pam-machine)

          * [Example: Linux Machine](/en/keeperpam/privileged-access-manager/getting-started/pam-resources/pam-machine/example-linux-machine)
          * [Example: Azure Windows VM](/en/keeperpam/privileged-access-manager/getting-started/pam-resources/pam-machine/example-azure-windows-vm)

        * [PAM Database](/en/keeperpam/privileged-access-manager/getting-started/pam-resources/pam-database)

          * [Example: MySQL Database](/en/keeperpam/privileged-access-manager/getting-started/pam-resources/pam-database/example-mysql-database)
          * [Example: PostgreSQL Database](/en/keeperpam/privileged-access-manager/getting-started/pam-resources/pam-database/example-postgresql-database)
          * [Example: Microsoft SQL Server Database](/en/keeperpam/privileged-access-manager/getting-started/pam-resources/pam-database/example-microsoft-sql-server-database)

        * [PAM Directory](/en/keeperpam/privileged-access-manager/getting-started/pam-resources/pam-directory)
        * [PAM Remote Browser](/en/keeperpam/privileged-access-manager/getting-started/pam-resources/pam-remote-browser)
        * [PAM User](/en/keeperpam/privileged-access-manager/getting-started/pam-resources/pam-user)

      * [Sharing and Access Control](/en/keeperpam/privileged-access-manager/getting-started/sharing-and-access-control)
      * [Just-In-Time Access (JIT)](/en/keeperpam/privileged-access-manager/getting-started/just-in-time-access-jit)

    * [Password Rotation](/en/keeperpam/privileged-access-manager/password-rotation)

      * [Rotation Overview](/en/keeperpam/privileged-access-manager/password-rotation/rotation-overview)
      * [Rotation Use Cases](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases)

        * [Azure](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/azure)

          * [Azure AD Users](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/azure/azure-ad-users)
          * [Azure VM User Accounts](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/azure/azure-vm-user-accounts)
          * [Azure Managed Database](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/azure/managed-database)

            * [Azure SQL](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/azure/managed-database/azure-sql)
            * [Azure MySQL - Single or Flexible Database](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/azure/managed-database/azure-mysql-single-or-flexible-database)
            * [Azure MariaDB Database](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/azure/managed-database/azure-mariadb-database)
            * [Azure PostgreSQL - Single or Flexible Database](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/azure/managed-database/azure-postgresql-single-or-flexible-database)

          * [Azure App Secret Rotation](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/azure/azure-app-secret-rotation)

        * [AWS](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/aws)

          * [IAM User Password](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/aws/iam-user)
          * [Managed Microsoft AD User](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/aws/directory-user)
          * [EC2 Virtual Machine User](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/aws/ec2-virtual-machine-user)
          * [IAM User Access Key](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/aws/iam-user-access-key)
          * [Managed Database](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/aws/managed-database)

            * [AWS RDS for MySQL](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/aws/managed-database/aws-rds-for-mysql)
            * [AWS RDS for SQL Server](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/aws/managed-database/aws-rds-for-sql-server)
            * [AWS RDS for PostgreSQL](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/aws/managed-database/aws-rds-for-postgresql)
            * [AWS RDS for MariaDB](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/aws/managed-database/aws-rds-for-mariadb)
            * [AWS RDS for Oracle](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/aws/managed-database/aws-rds-for-oracle)

        * [Local Network](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/local-network)

          * [Active Directory or OpenLDAP User](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/local-network/active-directory)
          * [Windows User](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/local-network/windows-user)
          * [Linux User](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/local-network/linux-user)
          * [macOS User](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/local-network/macos-user)
          * [Database](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/local-network/database)

            * [Native MySQL](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/local-network/database/mysql)
            * [Native MariaDB](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/local-network/database/mariadb)
            * [Native PostgreSQL](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/local-network/database/postgresql)
            * [Native MongoDB](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/local-network/database/mongodb)
            * [Native MS SQL Server](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/local-network/database/ms-sql-server)
            * [Native Oracle](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/local-network/database/oracle)

        * [SaaS Accounts](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/saas-accounts)

          * [Okta User](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/saas-accounts/okta-user)
          * [Snowflake User](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/saas-accounts/snowflake-user)
          * [Rotate Credential via REST API](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/saas-accounts/rotate-credential-via-rest-api)

        * [Network Devices](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/network-devices)

          * [Cisco IOS XE](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/network-devices/cisco-ios-xe)
          * [Cisco Meraki](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/network-devices/cisco-meraki)

      * [Service Management](/en/keeperpam/privileged-access-manager/password-rotation/service-management)
      * [Post-Rotation Scripts](/en/keeperpam/privileged-access-manager/password-rotation/post-rotation-scripts)

        * [Inputs and Outputs](/en/keeperpam/privileged-access-manager/password-rotation/post-rotation-scripts/parameters)
        * [Attaching Scripts](/en/keeperpam/privileged-access-manager/password-rotation/post-rotation-scripts/attaching-post-rotation-scripts-to-records)
        * [Code Examples](/en/keeperpam/privileged-access-manager/password-rotation/post-rotation-scripts/accessing-parameters)

    * [Connections](/en/keeperpam/privileged-access-manager/connections)

      * [Getting Started](/en/keeperpam/privileged-access-manager/connections/getting-started)
      * [Session Protocols](/en/keeperpam/privileged-access-manager/connections/session-protocols)

        * [SSH Connections](/en/keeperpam/privileged-access-manager/connections/session-protocols/ssh-connections)
        * [RDP Connections](/en/keeperpam/privileged-access-manager/connections/session-protocols/rdp-connections)
        * [RBI Connections](/en/keeperpam/privileged-access-manager/connections/session-protocols/rbi-connections)
        * [MySQL Connections](/en/keeperpam/privileged-access-manager/connections/session-protocols/mysql-connections)
        * [SQL Server Connections](/en/keeperpam/privileged-access-manager/connections/session-protocols/sql-server-connections)
        * [PostgreSQL Connections](/en/keeperpam/privileged-access-manager/connections/session-protocols/postgresql-connections)
        * [VNC Connections](/en/keeperpam/privileged-access-manager/connections/session-protocols/vnc-connections)
        * [Telnet Connections](/en/keeperpam/privileged-access-manager/connections/session-protocols/telnet-connections)

      * [Examples](/en/keeperpam/privileged-access-manager/connections/examples)

        * [SSH Protocol - Linux Machine](/en/keeperpam/privileged-access-manager/connections/examples/ssh-protocol-linux-machine)
        * [RDP Protocol - Azure Virtual Machine](/en/keeperpam/privileged-access-manager/connections/examples/rdp-protocol-azure-virtual-machine)
        * [MySQL Protocol - MySQL Database](/en/keeperpam/privileged-access-manager/connections/examples/mysql-protocol-mysql-database)
        * [PostgreSQL Protocol - PostgreSQL Database](/en/keeperpam/privileged-access-manager/connections/examples/postgresql-protocol-postgresql-database)

    * [Tunnels](/en/keeperpam/privileged-access-manager/tunnels)

      * [Setting up Tunnels](/en/keeperpam/privileged-access-manager/tunnels/setting-up-tunnels)

    * [Remote Browser Isolation](/en/keeperpam/privileged-access-manager/remote-browser-isolation)

      * [Setting up RBI](/en/keeperpam/privileged-access-manager/remote-browser-isolation/setting-up-rbi)

        * [URL Patterns & Resource URL Patterns](/en/keeperpam/privileged-access-manager/remote-browser-isolation/setting-up-rbi/url-patterns-and-resource-url-patterns)
        * [Browser Autofill](/en/keeperpam/privileged-access-manager/remote-browser-isolation/setting-up-rbi/browser-autofill)

    * [Session Recording & Playback](/en/keeperpam/privileged-access-manager/session-recording-and-playback)
    * [SSH Agent](/en/keeperpam/privileged-access-manager/ssh-agent)

      * [Integration with Git](/en/keeperpam/privileged-access-manager/ssh-agent/integration-with-git)

    * [Discovery](/en/keeperpam/privileged-access-manager/discovery)

      * [Discovery Basics](/en/keeperpam/privileged-access-manager/discovery/discovery-basics)
      * [Discovery using Commander](/en/keeperpam/privileged-access-manager/discovery/discovery-using-commander)
      * [Discovery using the Vault](/en/keeperpam/privileged-access-manager/discovery/discovery-using-the-vault)

    * [On-Prem Connection Manager](/en/keeperpam/privileged-access-manager/on-prem-connection-manager)
    * [References](/en/keeperpam/privileged-access-manager/references)

      * [Port Mapping](/en/keeperpam/privileged-access-manager/references/port-mapping)
      * [Setting up SSH](/en/keeperpam/privileged-access-manager/references/setting-up-ssh)
      * [Setting up WinRM](/en/keeperpam/privileged-access-manager/references/setting-up-winrm)
      * [Setting up SQL Server](/en/keeperpam/privileged-access-manager/references/setting-up-sql-server)
      * [Database Import and Export](/en/keeperpam/privileged-access-manager/references/database-import-and-export)
      * [Installing sqlcmd on Linux](/en/keeperpam/privileged-access-manager/references/installing-sqlcmd-on-linux)
      * [Installing Docker on Linux](/en/keeperpam/privileged-access-manager/references/installing-docker-on-linux)
      * [Creating KSM App for Rotation](/en/keeperpam/privileged-access-manager/references/creating-ksm-app-for-rotation)
      * [Active Directory Least Privilege](/en/keeperpam/privileged-access-manager/references/active-directory-least-privilege)
      * [Event Reporting](/en/keeperpam/privileged-access-manager/references/event-reporting)
      * [Importing PAM Records](/en/keeperpam/privileged-access-manager/references/importing-pam-records)
      * [Managing Rotation via CLI](/en/keeperpam/privileged-access-manager/references/managing-rotation-via-cli)
      * [Commander SDK](/en/keeperpam/privileged-access-manager/references/commander-sdk)
      * [Cron Spec](/en/keeperpam/privileged-access-manager/references/cron-spec)
      * [Preview Access](/en/keeperpam/privileged-access-manager/references/preview-access)

  * Endpoint Privilege Manager

    * [Overview](/en/keeperpam/endpoint-privilege-manager/overview)
    * [Setup](/en/keeperpam/endpoint-privilege-manager/setup)
    * [Deployment](/en/keeperpam/endpoint-privilege-manager/deployment)
    * [Policies](/en/keeperpam/endpoint-privilege-manager/policies)
    * [Managing Requests](/en/keeperpam/endpoint-privilege-manager/managing-requests)
  * [FAQs](/en/keeperpam/faqs)
  * Secrets Manager

    * [Secrets Manager Overview](/en/keeperpam/secrets-manager/overview)
    * [Quick Start Guide](/en/keeperpam/secrets-manager/quick-start-guide)
    * [About KSM](/en/keeperpam/secrets-manager/about)

      * [Architecture](/en/keeperpam/secrets-manager/about/architecture)
      * [Terminology](/en/keeperpam/secrets-manager/about/terminology)
      * [Security & Encryption Model](/en/keeperpam/secrets-manager/about/security-encryption-model)
      * [One Time Access Token](/en/keeperpam/secrets-manager/about/one-time-token)
      * [Secrets Manager Configuration](/en/keeperpam/secrets-manager/about/secrets-manager-configuration)
      * [Keeper Notation](/en/keeperpam/secrets-manager/about/keeper-notation)
      * [Event Reporting](/en/keeperpam/secrets-manager/about/event-reporting)
      * [Field/Record Types](/en/keeperpam/secrets-manager/about/field-record-types)

    * [Secrets Manager CLI](/en/keeperpam/secrets-manager/secrets-manager-command-line-interface)

      * [Profile Command](/en/keeperpam/secrets-manager/secrets-manager-command-line-interface/profile-command)
      * [Init Command](/en/keeperpam/secrets-manager/secrets-manager-command-line-interface/init-command)
      * [Secret Command](/en/keeperpam/secrets-manager/secrets-manager-command-line-interface/secret-command)
      * [Folder Command](/en/keeperpam/secrets-manager/secrets-manager-command-line-interface/folder-command)
      * [Sync Command](/en/keeperpam/secrets-manager/secrets-manager-command-line-interface/sync-command)
      * [Exec Command](/en/keeperpam/secrets-manager/secrets-manager-command-line-interface/exec-command)
      * [Config Command](/en/keeperpam/secrets-manager/secrets-manager-command-line-interface/config-command)
      * [Version Command](/en/keeperpam/secrets-manager/secrets-manager-command-line-interface/version-command)
      * [Misc Commands](/en/keeperpam/secrets-manager/secrets-manager-command-line-interface/vault-admin-commands)
      * [Docker Container](/en/keeperpam/secrets-manager/secrets-manager-command-line-interface/docker-container)
      * [Custom Record Types](/en/keeperpam/secrets-manager/secrets-manager-command-line-interface/custom-record-types)

    * [Password Rotation](/en/keeperpam/secrets-manager/password-rotation)
    * [Developer SDKs](/en/keeperpam/secrets-manager/developer-sdk-library)

      * [Python SDK](/en/keeperpam/secrets-manager/developer-sdk-library/python-sdk)
      * [Java/Kotlin SDK](/en/keeperpam/secrets-manager/developer-sdk-library/java-sdk)

        * [Record Field Classes](/en/keeperpam/secrets-manager/developer-sdk-library/java-sdk/record-field-classes)

      * [JavaScript SDK](/en/keeperpam/secrets-manager/developer-sdk-library/javascript-sdk)
      * [.NET SDK](/en/keeperpam/secrets-manager/developer-sdk-library/.net-sdk)
      * [Go SDK](/en/keeperpam/secrets-manager/developer-sdk-library/golang-sdk)

        * [Record Field Classes](/en/keeperpam/secrets-manager/developer-sdk-library/golang-sdk/record-field-classes)

      * [PowerShell](/en/keeperpam/secrets-manager/developer-sdk-library/powershell)
      * [Vault SDKs](/en/keeperpam/secrets-manager/developer-sdk-library/vault-sdks)

    * [Integrations](/en/keeperpam/secrets-manager/integrations)

      * [Ansible](/en/keeperpam/secrets-manager/integrations/ansible)

        * [Ansible Plugin](/en/keeperpam/secrets-manager/integrations/ansible/ansible-plugin)
        * [Ansible Tower](/en/keeperpam/secrets-manager/integrations/ansible/ansible-tower)

      * [AWS CLI Credential Process](/en/keeperpam/secrets-manager/integrations/aws-cli-credential-process)
      * [AWS Secrets Manager](/en/keeperpam/secrets-manager/integrations/aws-secrets-manager)
      * [AWS KMS](/en/keeperpam/secrets-manager/integrations/aws-kms)
      * [Azure DevOps Extension](/en/keeperpam/secrets-manager/integrations/azure-devops-plugin)
      * [Azure Key Vault](/en/keeperpam/secrets-manager/integrations/azure-key-vault)
      * [Bitbucket Plugin](/en/keeperpam/secrets-manager/integrations/bitbucket-plugin)
      * [Docker Image](/en/keeperpam/secrets-manager/integrations/docker-image)
      * [Docker Runtime](/en/keeperpam/secrets-manager/integrations/docker-runtime)
      * [Docker Writer Image](/en/keeperpam/secrets-manager/integrations/docker-writer-image)
      * [Entrust HSM](/en/keeperpam/secrets-manager/integrations/entrust-hsm)
      * [GCP Secret Manager](/en/keeperpam/secrets-manager/integrations/gcp-secret-manager)
      * [Git - Sign Commits with SSH](/en/keeperpam/secrets-manager/integrations/git-sign-commits-with-ssh)
      * [GitHub Actions](/en/keeperpam/secrets-manager/integrations/github-actions)
      * [GitLab](/en/keeperpam/secrets-manager/integrations/gitlab-plugin)
      * [Hashicorp Vault](/en/keeperpam/secrets-manager/integrations/hashicorp-vault)
      * [Heroku](/en/keeperpam/secrets-manager/integrations/heroku)
      * [Jenkins Plugin](/en/keeperpam/secrets-manager/integrations/jenkins-plugin)
      * [Keeper Connection Manager](/en/keeperpam/secrets-manager/integrations/keeper-connection-manager)
      * [Kubernetes External Secrets Operator](/en/keeperpam/secrets-manager/integrations/kubernetes-external-secrets-operator)
      * [Kubernetes (alternative)](/en/keeperpam/secrets-manager/integrations/kubernetes)
      * [Linux Keyring](/en/keeperpam/secrets-manager/integrations/linux-keyring)
      * [Octopus Deploy](/en/keeperpam/secrets-manager/integrations/octopus-deploy)
      * [Oracle Key Vault](/en/keeperpam/secrets-manager/integrations/aws-kms-1)
      * [PowerShell Plugin](/en/keeperpam/secrets-manager/integrations/powershell-plugin)
      * [ServiceNow](/en/keeperpam/secrets-manager/integrations/servicenow)
      * [Teller](/en/keeperpam/secrets-manager/integrations/teller)
      * [TeamCity](/en/keeperpam/secrets-manager/integrations/teamcity)
      * [Terraform Plugin](/en/keeperpam/secrets-manager/integrations/terraform)

        * [Terraform Registry](https://registry.terraform.io/providers/Keeper-Security/secretsmanager/latest/docs/data-sources/address)

      * [Windows Credential Manager](/en/keeperpam/secrets-manager/integrations/windows-credential-manager)
      * [XSOAR](/en/keeperpam/secrets-manager/integrations/xsoar)

    * [Troubleshooting](/en/keeperpam/secrets-manager/troubleshooting)
  * Commander CLI

    * [Commander Overview](/en/keeperpam/commander-cli/overview)
    * [Installation and Setup](/en/keeperpam/commander-cli/commander-installation-setup)

      * [CLI Installation on Windows](/en/keeperpam/commander-cli/commander-installation-setup/installation-on-windows)
      * [CLI Installation on macOS](/en/keeperpam/commander-cli/commander-installation-setup/installation-on-mac)
      * [CLI Installation on Linux](/en/keeperpam/commander-cli/commander-installation-setup/installation-on-linux)
      * [Python Developer Setup](/en/keeperpam/commander-cli/commander-installation-setup/developer-mode)
      * [.NET Developer Setup](/en/keeperpam/commander-cli/commander-installation-setup/net-developer-sdk)
      * [PowerShell Module](/en/keeperpam/commander-cli/commander-installation-setup/installation-on-powershell)
      * [Logging in](/en/keeperpam/commander-cli/commander-installation-setup/logging-in)
      * [Configuration and Usage](/en/keeperpam/commander-cli/commander-installation-setup/configuration)

        * [AWS Secrets Manager](/en/keeperpam/commander-cli/commander-installation-setup/configuration/aws-secrets-manager)
        * [AWS Key Management Service](/en/keeperpam/commander-cli/commander-installation-setup/configuration/aws-key-management-service)

      * [Automating with Windows Task](/en/keeperpam/commander-cli/commander-installation-setup/automating-with-windows-task)
      * [Automating with AWS Lambda](/en/keeperpam/commander-cli/commander-installation-setup/using-commander-with-aws-lambda)
      * [Uninstallation](/en/keeperpam/commander-cli/commander-installation-setup/uninstallation)

    * [Command Reference](/en/keeperpam/commander-cli/command-reference)

      * [Import and Export Data](/en/keeperpam/commander-cli/command-reference/import-and-export-commands)

        * [Import/Export Commands](/en/keeperpam/commander-cli/command-reference/import-and-export-commands/import-export-commands)
        * [CyberArk Import](/en/keeperpam/commander-cli/command-reference/import-and-export-commands/cyberark-import)
        * [LastPass Data Import](/en/keeperpam/commander-cli/command-reference/import-and-export-commands/lastpass-import)
        * [Delinea / Thycotic Secret Server Import](/en/keeperpam/commander-cli/command-reference/import-and-export-commands/delinea-thycotic-secret-server-import)
        * [Keepass Import](/en/keeperpam/commander-cli/command-reference/import-and-export-commands/keepass-import)
        * [ManageEngine Import](/en/keeperpam/commander-cli/command-reference/import-and-export-commands/manageengine-import)
        * [Myki Import](/en/keeperpam/commander-cli/command-reference/import-and-export-commands/myki-import)
        * [Proton Pass Import](/en/keeperpam/commander-cli/command-reference/import-and-export-commands/proton-pass-import)
        * [CSV Import](/en/keeperpam/commander-cli/command-reference/import-and-export-commands/csv-import)
        * [JSON Import](/en/keeperpam/commander-cli/command-reference/import-and-export-commands/json-import)

      * [Reporting Commands](/en/keeperpam/commander-cli/command-reference/reporting-commands)

        * [Report Types](/en/keeperpam/commander-cli/command-reference/reporting-commands/report-types)

      * [Enterprise Management Commands](/en/keeperpam/commander-cli/command-reference/enterprise-management-commands)

        * [Creating and Inviting Users](/en/keeperpam/commander-cli/command-reference/enterprise-management-commands/creating-and-inviting-users)
        * [Compliance Commands](/en/keeperpam/commander-cli/command-reference/enterprise-management-commands/compliance-commands)
        * [Breachwatch Commands](/en/keeperpam/commander-cli/command-reference/enterprise-management-commands/breachwatch-commands)
        * [SCIM Push Configuration](/en/keeperpam/commander-cli/command-reference/enterprise-management-commands/scim-push-configuration)

      * [Record Commands](/en/keeperpam/commander-cli/command-reference/record-commands)

        * [Record Type Commands](/en/keeperpam/commander-cli/command-reference/record-commands/record-type-commands)
        * [Creating Record Types](/en/keeperpam/commander-cli/command-reference/record-commands/default-record-types)

      * [Sharing Commands](/en/keeperpam/commander-cli/command-reference/sharing-commands)
      * [KeeperPAM Commands](/en/keeperpam/commander-cli/command-reference/keeperpam-commands)
      * [Connection Commands](/en/keeperpam/commander-cli/command-reference/connection-commands)

        * [SSH](/en/keeperpam/commander-cli/command-reference/connection-commands/ssh)
        * [SSH Agent](/en/keeperpam/commander-cli/command-reference/connection-commands/ssh-agent)
        * [RDP](/en/keeperpam/commander-cli/command-reference/connection-commands/rdp)
        * [Connect Command](/en/keeperpam/commander-cli/command-reference/connection-commands/connection-to-hosts)
        * [SFTP Sync](/en/keeperpam/commander-cli/command-reference/connection-commands/sftp-sync)

      * [Secrets Manager Commands](/en/keeperpam/commander-cli/command-reference/secrets-manager-commands)
      * [MSP Management Commands](/en/keeperpam/commander-cli/command-reference/msp-management-commands)
      * [Miscellaneous Commands](/en/keeperpam/commander-cli/command-reference/misc-commands)
      * [Password Rotation](/en/keeperpam/commander-cli/command-reference/plugins)

        * [Password Rotation Commands](/en/keeperpam/commander-cli/command-reference/plugins/password-rotation)
        * [AWS Plugin](/en/keeperpam/commander-cli/command-reference/plugins/aws-plugin)
        * [Azure Plugin](/en/keeperpam/commander-cli/command-reference/plugins/azure-plugin)
        * [Microsoft SQL Server Plugin](/en/keeperpam/commander-cli/command-reference/plugins/microsoft-sql-server-plugin)
        * [MySQL Plugin](/en/keeperpam/commander-cli/command-reference/plugins/mysql-plugin)
        * [Oracle Plugin](/en/keeperpam/commander-cli/command-reference/plugins/oracle-plugin)
        * [PostgreSQL Plugin](/en/keeperpam/commander-cli/command-reference/plugins/postgresql-plugin)
        * [PSPasswd Plugin](/en/keeperpam/commander-cli/command-reference/plugins/pspasswd-plugin)
        * [SSH Plugin](/en/keeperpam/commander-cli/command-reference/plugins/ssh-plugin)
        * [Unix Passwd Plugin](/en/keeperpam/commander-cli/command-reference/plugins/unix-passwd-plugin)
        * [Windows Plugin](/en/keeperpam/commander-cli/command-reference/plugins/windows-plugin)
        * [Active Directory Plugin](/en/keeperpam/commander-cli/command-reference/plugins/active-directory-plugin)
        * [Automatic Execution](/en/keeperpam/commander-cli/command-reference/plugins/automatic-execution)

    * [Service Mode REST API](/en/keeperpam/commander-cli/service-mode-rest-api)
    * [Troubleshooting](/en/keeperpam/commander-cli/troubleshooting-commander-cli)

[Powered by
GitBook](https://www.gitbook.com/?utm_source=content&utm_medium=trademark&utm_campaign=-MJXOXEifAmpyvNVL1to)

On this page

  * Overview
  * Prerequisites
  * Rotation Script Logic Flow
  * 1\. Admin Credentials Retrieval
  * 2\. Key Rotation Logics
  * 3\. Updating the Keeper PAM User Record in the Vault
  * PAM User Record - Fields Requirements
  * Fields required:
  * Custom fields required:
  * Setting Up the Rotation in the Keeper Vault
  * Python Script

Was this helpful?

[Export as
PDF](/en/keeperpam/~gitbook/pdf?page=UXgooa1QOv7hwvQL1myx&only=yes&limit=100)

  1. [Privileged Access Manager](/en/keeperpam/privileged-access-manager)
  2. [Password Rotation](/en/keeperpam/privileged-access-manager/password-rotation)
  3. [Rotation Use Cases](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases)
  4. [AWS](/en/keeperpam/privileged-access-manager/password-rotation/rotation-use-cases/aws)

# IAM User Access Key

Automatically rotate AWS access keys using Keeper Secrets Manager rotations

##

Overview

This documentation explains how to rotate AWS IAM user access keys using
KeeperPAM's rotation option called "Run PAM scripts only". This is a setting
in the PAM User rotation settings which tells the Gateway to skip the primary
rotation method and directly execute the post-rotation script attached to the
PAM User record in the vault.

This guide includes prerequisites, step-by-step instructions, and a Python
script example. This provided script supports both provided admin credentials
(AWS Access key for an admin account) and EC2 instance role authentication.
The script ensures secure access key rotation, including deletion of previous
user keys. The new key is stored in the Keeper record after rotation is
complete.

##

Prerequisites

  1. **KSM role:** Ensure that the Keeper user has a role providing access to Keeper Secrets Manager, and Keeper Secrets Manager rotations.

  2. **A Linux instance to run the Keeper Gateway:** The Gateway can be deployed in an EC2 instance, any private Cloud or on-prem. This script is capable of leveraging EC2 Instance Roles Authentication to perform the Access Key rotation if the Gateway runs in an EC2 instance. If the gateway runs somewhere else, then an Access Key with role privilege needs to be provided in the Keeper vault to perform the rotation of the end user Access Key.

##

Rotation Script Logic Flow

###

1\. Admin Credentials Retrieval

The script retrieve admin credentials in three ways:

  1. Record directly attached to the post rotation script.

  2. The access key provided to the AWS PAM config selected for the rotation. This will be used if no access key is found in the record attached (method 1 above) to the post rotation script.

  3. Uses AWS instance role authentication if no credentials are provided from either methods above. The gateway needs to be running on an EC2 Instance with an EC2 Instance Role in place.

###

2\. Key Rotation Logics

The script provides two modes of operation based on the
delete_all_keys_before_rotating custom field:

  * If False (default), a new access key is created first, then the old ones are deleted, keeping only the newly created key. This will fail if the user account has already two access keys: AWS will not allow the script to create a third one.

  * If this custom field is set to True, the script deletes all existing access keys for the IAM user before creating a new one. This helps in the scenario described above where the end user account has already two access keys.

###

3\. Updating the Keeper PAM User Record in the Vault

After key rotation, the script updates the rotated PAM User Keeper record with
the new AWS access key ID, secret access key, creation date, and any deleted
access keys IDs.

##

PAM User Record - Fields Requirements

You need to create a PAM User record where the rotation will be configured
later on. The fields below need to be created.

###

Fields required:

Field Name

Description

Login

Name of the user account in AWS where the access key needs to be rotated.

Password

It will be a dummy value in this case. The password field gets automatically
rotated, but it is not used anywhere. This is still required field.

###

Custom fields required:

Custom Field Label

Field Type

Description

Copy

    
    
    aws_access_key_id

Text

This field will receive the new access key id after the rotation.

Copy

    
    
    aws_secret_access_key

Hidden Field

This field will receive the new secret access key after the rotation.

Copy

    
    
    CreateDate

Text

This field will contain the timestamp of when the new key has been generated
by the script.

Copy

    
    
    Access_Key_ID_Removed_during_previous_rotation

Text

This field will contain the old access key id(s) removed from the user account
in AWS during the rotation.

Copy

    
    
    delete_all_keys_before_rotating

Text

This custom field is optional. It could be set to “False” or “True”, the
default value is “False”.

If set to “True” then the rotation script will start by deleting all existing
access keys on the user account before creating a new one. This is needed when
the user has already 2 access keys setup. AWS will not allow the script to
create a third one, hence the need to delete the existing keys before adding a
new one.

Copy

    
    
    NOOP

Text

This rotation requires the gateway to only execute the rotation script, and
not try to rotate something using the built-in rotation features.

The value has to be:

Copy

    
    
    True

Copy

    
    
    Private Key Type

Text

Second field to enable NOOP.

The value has to be:

Copy

    
    
    rsa-ssh

Instead of creating the PAM User record manually using the details above, you
could also import the csv file below. It will create a template record you can
amend and duplicate as needed. Importing the file will generate a Login record
type: **make sure to convert it to PAM User**.

##

Setting Up the Rotation in the Keeper Vault

Using AWS Instance RoleUsing AWS PAM ConfigUsing Another Keeper Record

When the gateway runs in an EC2 instance, you don’t need to provide an admin
access key to the script. The gateway will leverage the AWS Instance Role
permissions assigned to the VM.

The steps below explains how to set up an EC2 Instance role to the gateway EC2
instance with minimal permissions:

###

Steps to Add/Configure Instance Role With Minimum Permissions to Rotate Access
Keys:

####

Step 1: Create a Policy in AWS

  1. Go to the [IAM Management Console](https://console.aws.amazon.com/iam).

  2. Select Policies and click Create policy.

  3. Select JSON and paste the following, make sure to replace your AWS Account ID:

Copy

    
    
    {
      "Version": "2012-10-17",
      "Statement": [
        {
          "Effect": "Allow",
          "Action": [
            "iam:CreateAccessKey",
            "iam:ListAccessKeys",
            "iam:DeleteAccessKey"
          ],
          "Resource": "arn:aws:iam::YOUR_AWS_ACCOUNT_ID_HERE:user/*"
        }
      ]
    }
    

  1. Name the policy and save it.

####

Step 2: Create an IAM Role in AWS

  1. Go to the IAM Management Console.

  2. Select Roles and click create role.

  3. Choose AWS service and select EC2.

  1. Attach the necessary IAM policies (e.g., the policy we created above with the minimum permissions).

####

Step 3: Assign the Role to Your EC2 Instance

  1. In the EC2 Management Console, find your instance.

  2. Click Actions > Security > Modify IAM Role.

  1. Select the role you created and click Update

  1. Verify Instance Role Permissions

You can ensure that the instance role has appropriate permissions to interact
with IAM by running the command below on the Gateway EC2 Instance:

Copy

    
    
    aws sts get-caller-identity

After configuring this role, your EC2 instance, in this case your Keeper
Gateway, will automatically use the attached role credentials for your script,
allowing it to perform actions like creating and deleting IAM access keys
without needing explicit access key credentials.

###

Rotation Configuration From the Vault:

  1. Create a shared folder in the vault

  2.   3. In the Secret Manager tab of the Keeper vault, create a new application for the gateway if there is no gateway yet. 

  4. Make sure the Application has edit permissions on the shared folder created above.

  5. Provision the gateway (gateway tab after selecting the application) on an EC2 instance. On the EC2 Instance run the install command provided by the Keeper vault and make sure boto3 and keeper_secrets_manager_core are installed by running the following commands in the EC2 instance:

Copy

    
    
    pip3 install boto3
    pip3 install keeper_secrets_manager_core

  1. In the Secret Manager tab of the Keeper vault, go to the PAM Configurations tab. Create a new PAM configuration if needed.

  2. Under Environment you can select “Local Network” or “AWS”. If you select “AWS”, please make sure to leave the “Access Key” and “Secret Access Key” field empty. If you provide one, it will be automatically used by the script instead of using the Instance Role authentication. You will still need to provide the AWS Account ID to the AWS PAM configuration.

  3. Select the gateway, select the shared folder and save the PAM configuration.

  1.      * Password Rotation Settings: select your desired schedule and the PAM configuration created above.

     * Add PAM Script to the record: select the provided file below and make sure to specify the script command:

Copy

    
    
    python3

When the gateway does not run in an EC2 instance, it will require an admin
access key to authenticate against AWS and rotate another user's access key.
Here we will be using the admin access key provided in the AWS PAM
Configuration.

###

Configuration From the Keeper Vault:

  1. Create a shared folder in the vault

  2. 

  1. In the Secret Manager tab of the Keeper vault, create a new application for the gateway if there is no gateway yet. 

  2. Make sure the Application has edit permissions on the shared folder created above.

  3. Provision the gateway (gateway tab after selecting the application) on a Linux box. Simply run the install command provided by the Keeper vault and make sure boto3 and keeper_secrets_manager_core are installed by running the following commands on the Linux box:

Copy

    
    
    pip3 install boto3
    pip3 install keeper_secrets_manager_core

  1. In the Secret Manager tab of the Keeper vault, go to the PAM Configurations tab. Create a new PAM configuration if needed.

  2. Under Environment, please select “AWS”, select the Gateway, select the shared folder, provide the “AWS ID”, the “Access Key” and “Secret Access Key”. This will be the admin access key that the script uses to rotate a user access key.

  1.      * Password Rotation Settings: select your desired schedule and the PAM configuration created above.

     * Add PAM Script to the record: select the provided file below and make sure to specify the script command:

Copy

    
    
    python3

When the gateway does not run in an EC2 instance, it will require an admin
access key to authenticate against AWS and rotate another user's access key.
Here we will be using the admin access key provided in another Keeper record.
This option also allows to **rotate the admin access key the same way Keeper
rotates an user access key**.

You may have followed any of the two other tabs available in this doc (Using
AWS instance role, or Using AWS PAM Config) to set up the rotation: you will
have a PAM configuration that contains or does not contain an access key.
Following the steps below will force the use of an admin access key stored in
another Keeper record.

###

Configuration From the Keeper Vault:

When attaching the PAM Script to the PAM user record, it is possible to attach
Rotation Credentials.

The attached record could be any record type. It needs at least the two custom
fields “aws_access_key_id” and “aws_secret_access_key” with the admin access
key.

###

Using AWS AssumeRole to rotate user access keys across other AWS accounts

When attaching a record to the PAM script itself to provide an admin AWS
access keys also allows to leverage AWS AssumeRole to rotate an AWS user
access key across multiple AWS accounts.

More information about AWS AssumeRole
[here](https://docs.aws.amazon.com/STS/latest/APIReference/API_AssumeRole.html).

To leverage this feature, you need to add a new custom field to the record
attached to the PAM script (Rotation Credentials).

The custom field label needs to be:

Copy

    
    
    role_arn

This field will contain the role arn from your AWS environment that has the
permissions to rotate access keys in other AWS accounts.

When this field exists, the rotation script will use it along with the
provided admin access key ID and secret to generate a new temporary access key
to rotate the end user’s one in the other AWS account. The script will then
update the Keeper PAM User record with the new key and information, the same
way it usually does without this extra field.

##

Python Script

Copy

    
    
    import boto3
    import sys
    import base64
    import json
    from keeper_secrets_manager_core import SecretsManager
    from keeper_secrets_manager_core.storage import FileKeyValueStorage
    from botocore.exceptions import ClientError, NoCredentialsError
    
    # sys.stdin is not an array, it cannot be subscripted (i.e., sys.stdin[0])
    for base64_params in sys.stdin:
        # Retrieve params from the gateway
        params = json.loads(base64.b64decode(base64_params).decode('utf-8'))
        break
    
    # Retrieve records attached to the post-rotation script in Keeper
    records = json.loads(base64.b64decode(params.get('records')).decode('utf-8'))
    
    # Initiate Keeper Secrets Manager SDK using the gateway configuration
    secrets_manager = SecretsManager(config=FileKeyValueStorage('/etc/keeper-gateway/gateway-config.json'))
    
    # Function to create a new access key for a user
    def create_new_access_key(iam_client, user_name: str) -> tuple:
        new_key = iam_client.create_access_key(UserName=user_name)
        return new_key['AccessKey']['AccessKeyId'], new_key['AccessKey']['SecretAccessKey'], new_key['AccessKey']['CreateDate']
    
    # Function to rotate user's access key
    def rotate_user_access_key(iam_client, user_name: str) -> dict:
        if not user_name:
            raise ValueError("User name is required for rotation")
    
        try:
            # Step 1: Create a new access key for the user
            new_access_key_id, new_secret_access_key, create_date = create_new_access_key(iam_client, user_name)
    
            print(f"New Access Key created successfully for user {user_name}")
    
            # Step 2: List all existing access keys for the user
            existing_keys = iam_client.list_access_keys(UserName=user_name)
            deleted_keys = [access_key['AccessKeyId'] for access_key in existing_keys['AccessKeyMetadata']
                            if access_key['AccessKeyId'] != new_access_key_id]
    
            # Step 3: Delete all other access keys, except the newly created one
            for access_key_id in deleted_keys:
                iam_client.delete_access_key(UserName=user_name, AccessKeyId=access_key_id)
    
            # Return the results
            return {
                'NewAccessKeyId': new_access_key_id,
                'NewSecretAccessKey': new_secret_access_key,
                'CreateDate': create_date,
                'DeletedAccessKeys': deleted_keys
            }
    
        except ClientError as e:
            print(f"An error occurred: {e}")
            raise e
    
    # Function to delete all keys and then rotate user's access key
    def delete_then_rotate_user_access_key(iam_client, user_name: str) -> dict:
        try:
            # Step 1: List all existing access keys for the user
            existing_keys = iam_client.list_access_keys(UserName=user_name)
            deleted_keys = [access_key['AccessKeyId'] for access_key in existing_keys['AccessKeyMetadata']]
    
            # Step 2: Delete all keys
            for access_key_id in deleted_keys:
                iam_client.delete_access_key(UserName=user_name, AccessKeyId=access_key_id)
    
            # Step 3: Create a new access key for the user
            new_access_key_id, new_secret_access_key, create_date = create_new_access_key(iam_client, user_name)
    
            print(f"New Access Key created successfully for user {user_name}")
    
            # Return the results
            return {
                'NewAccessKeyId': new_access_key_id,
                'NewSecretAccessKey': new_secret_access_key,
                'CreateDate': create_date,
                'DeletedAccessKeys': deleted_keys
            }
    
        except ClientError as e:
            print(f"An error occurred: {e}")
            raise e
    
    # Function to assume the role in the target AWS account
    def assume_role_in_target_account(role_arn, session_name='CrossAccountSession'):
        sts_client = boto3.client('sts')
        try:
            assumed_role = sts_client.assume_role(
                RoleArn=role_arn,
                RoleSessionName=session_name
            )
            credentials = assumed_role['Credentials']
            return {
                'aws_access_key_id': credentials['AccessKeyId'],
                'aws_secret_access_key': credentials['SecretAccessKey'],
                'aws_session_token': credentials['SessionToken']
            }
        except ClientError as e:
            print(f"Error assuming role: {e}")
            raise e
    
    # Inputs from the gateway and full PAM user query using KSM
    pam_user_to_update = secrets_manager.get_secrets([params.get('userRecordUid')])[0]
    user_name = params.get('user')
    
    # Retrieve admin user account access key
    aws_admin_cred_provided = False
    for record in records:
        if "role_arn" in record: # AssumeRole auth detected from the Keeper record
            aws_admin_cred_provided = True
            role_arn = record["role_arn"]
            aws_access_key_id = record["aws_access_key_id"]
            aws_secret_access_key = record["aws_secret_access_key"]
            print(f"Admin access key provided along with role arn for AWS AssumeRole. Using Access Key ID {aws_access_key_id}, from record UID {record['uid']}.")
            # Assume the role and get temporary credentials
            assumed_role_credentials = assume_role_in_target_account(role_arn)
            # Initialize IAM client using the assumed role's credentials
            iam_client = boto3.client(
                'iam',
                aws_access_key_id=assumed_role_credentials['aws_access_key_id'],
                aws_secret_access_key=assumed_role_credentials['aws_secret_access_key'],
                aws_session_token=assumed_role_credentials['aws_session_token'],
                region_name='us-east-1'
            )
            break
        if "aws_access_key_id" in record:
            aws_admin_cred_provided = True
            aws_access_key_id = record["aws_access_key_id"]
            aws_secret_access_key = record["aws_secret_access_key"]
            print(f"Admin access key provided. Using Access Key ID {aws_access_key_id}, from record UID {record['uid']}.")
            # Initialize IAM client with admin credentials
            iam_client = boto3.client('iam',
                                      aws_access_key_id=aws_access_key_id,
                                      aws_secret_access_key=aws_secret_access_key,
                                      region_name='us-east-1')
            break
        if "accessKeyId" in record:
            aws_admin_cred_provided = True
            aws_access_key_id = record["accessKeyId"]
            aws_secret_access_key = record["accessSecretKey"]
            print(f"Admin access key provided. Using Access Key ID {aws_access_key_id}, from record UID {record['uid']}.")
            # Initialize IAM client with admin credentials
            iam_client = boto3.client('iam',
                                      aws_access_key_id=aws_access_key_id,
                                      aws_secret_access_key=aws_secret_access_key,
                                      region_name='us-east-1')
            break
    else:
        try:
            # Try to retrieve admin access key from the PAM config using Keeper Secrets Manager
            pam_config = secrets_manager.get_secrets([params.get('providerRecordUid')])[0]
            aws_access_key_id = pam_config.field('accessKeyId', single=True)
            aws_secret_access_key = pam_config.field('accessSecretKey', single=True)
    
            # Check if keys are retrieved successfully
            if aws_access_key_id and aws_secret_access_key:
                aws_admin_cred_provided = True
                print(f"Admin access key retrieved from the PAM Config. Using Access Key ID {aws_access_key_id}, from the PAM Config.")
                # Initialize IAM client with admin credentials
                iam_client = boto3.client('iam',
                                          aws_access_key_id=aws_access_key_id,
                                          aws_secret_access_key=aws_secret_access_key,
                                          region_name='us-east-1')
            else:
                print("Access key ID or secret key not found in the retrieved Keeper Secrets Manager record.")
        except Exception as e:
            # Handle any error that occurs during retrieval
            print(f"Error retrieving admin access key: {e}")
    
    # Check for instance role credentials if no admin access key is provided
    if not aws_admin_cred_provided:
        print("No admin access key provided. Checking for instance role authentication...")
        try:
            # Test if instance role credentials are available by creating an IAM client without credentials
            iam_client = boto3.client('iam')
            iam_client.list_access_keys(UserName=user_name)  # Test if we can access the API
            aws_admin_cred_provided = True
            print("Instance role credentials found. Using instance role authentication.")
        except NoCredentialsError:
            print("No instance role credentials available.")
        except ClientError as e:
            print(f"Error using instance role credentials: {e}")
    
    # Exit if no credentials were provided
    if not aws_admin_cred_provided:
        raise RuntimeError("No admin access key or instance role credentials provided. The script will exit.")
    
    # Check if the user specified a delete_all_keys_before_rotating custom field
    try:
        delete_all_keys_before_rotating = pam_user_to_update.custom_field('delete_all_keys_before_rotating', single=True)
        delete_all_keys_before_rotating = str(delete_all_keys_before_rotating).lower() in ['true', 'yes', '1']
    except Exception as e:
        print(f"OPTIONAL field 'delete_all_keys_before_rotating' not found: {e}")
        delete_all_keys_before_rotating = False  # Set to false if an error occurs
    
    # Call the right rotate function based on user parameters
    if delete_all_keys_before_rotating:
        result = delete_then_rotate_user_access_key(iam_client, user_name=user_name)
    else:
        result = rotate_user_access_key(iam_client, user_name=user_name)
    
    if result:
        print("\nRotation Result:")
        print(f"New Access Key ID: {result['NewAccessKeyId']}")
        print(f"Create Date: {result['CreateDate']}")
        print(f"Deleted Access Keys: {result['DeletedAccessKeys']}")
    
        # Update the PAM User record in Keeper
        pam_user_to_update.custom_field('aws_access_key_id', result['NewAccessKeyId'])
        pam_user_to_update.custom_field('aws_secret_access_key', result['NewSecretAccessKey'])
        create_date_str = result['CreateDate'].isoformat() if hasattr(result['CreateDate'], 'isoformat') else str(result['CreateDate'])  # Convert the create_date to string format
        pam_user_to_update.custom_field('CreateDate', create_date_str)
        deleted_keys_str = ', '.join(result['DeletedAccessKeys'])  # Convert deleted access keys to a comma-separated string
        pam_user_to_update.custom_field('Access_Key_ID_Removed_during_previous_rotation', deleted_keys_str)
        secrets_manager.save(pam_user_to_update)

[PreviousEC2 Virtual Machine User](/en/keeperpam/privileged-access-
manager/password-rotation/rotation-use-cases/aws/ec2-virtual-machine-
user)[NextManaged Database](/en/keeperpam/privileged-access-manager/password-
rotation/rotation-use-cases/aws/managed-database)

Last updated 2 months ago

Was this helpful?

#### Company

  * [Keeper Home](https://www.keepersecurity.com/)
  * [About Us](https://www.keepersecurity.com/about.html)
  * [Careers](https://www.keepersecurity.com/jobs.html)
  * [Security](https://www.keepersecurity.com/security.html)

#### Support

  * [Help Center](https://www.keepersecurity.com/support.html)
  * [Contact Sales](https://www.keepersecurity.com/contact.html?t=b&r=sales)
  * [System Status](https://statuspage.keeper.io/)
  * [Terms of Use](https://www.keepersecurity.com/termsofuse.html)

#### Solutions

  * [Enterprise Password Management](https://www.keepersecurity.com/enterprise.html)
  * [Business Password Management](https://www.keepersecurity.com/business.html)
  * [Privileged Access Management](https://www.keepersecurity.com/privileged-access-management/)
  * [Public Sector](https://www.keepersecurity.com/government-cloud/)

#### Pricing

  * [Business and Enterprise](https://www.keepersecurity.com/pricing/business-and-enterprise.html)
  * [Personal and Family](https://www.keepersecurity.com/pricing/personal-and-family.html)
  * [Student](https://www.keepersecurity.com/student-discount-50off.html)
  * [Military and Medical](https://www.keepersecurity.com/id-me-verification.html)

© 2025 Keeper Security, Inc.

Create a PAM User record in the shared folder with the fields and custom
fields described .

Edit the PAM User record previously described in this :

Create a PAM User record in the shared folder with the fields and custom
fields described .

Edit the PAM User record previously described in this :

Using the PAM User record type to store the admin access key allows you to
also **automate the rotation of the admin access key**. Make sure to follow
in that case.

[above](/en/keeperpam/privileged-access-manager/password-rotation/rotation-
use-cases/aws/iam-user-access-key#pam-user-record-fields-requirements)

[documentation](/en/keeperpam/privileged-access-manager/password-
rotation/rotation-use-cases/aws/iam-user-access-key#pam-user-record-fields-
requirements)

[above](/en/keeperpam/privileged-access-manager/password-rotation/rotation-
use-cases/aws/iam-user-access-key#pam-user-record-fields-requirements)

[documentation](/en/keeperpam/privileged-access-manager/password-
rotation/rotation-use-cases/aws/iam-user-access-key#pam-user-record-fields-
requirements)

[those requirements](/en/keeperpam/privileged-access-manager/password-
rotation/rotation-use-cases/aws/iam-user-access-key#pam-user-record-fields-
requirements)

[213BPAM User
template.csv](https://762006384-files.gitbook.io/~/files/v0/b/gitbook-x-
prod.appspot.com/o/spaces%2F-MJXOXEifAmpyvNVL1to%2Fuploads%2FYR6dnIzAWf8lqZdK0QYo%2FPAM%20User%20template.csv?alt=media&token=33d35c09-b0f3-47c0-b6ab-877ee1d1250f)

CSV file to easily create a PAM User template record via an import in the
vault

[10KBRotateAWSAccessKeys.py](https://762006384-files.gitbook.io/~/files/v0/b/gitbook-
x-
prod.appspot.com/o/spaces%2F-MJXOXEifAmpyvNVL1to%2Fuploads%2FjbAzV7zvd4doh46XBOmN%2FRotateAWSAccessKeys.py?alt=media&token=e1c688cf-c4c1-4d2d-a402-37330962e9da)

Download script

PAM User record example

Create a policy in AWS

Create an IAM role in AWS

Attach the policy to the role in AWS

EC2 Instance contextual menu

Assign IAM role to EC2 instance

PAM Configuration without providing an AWS access key

Attach PAM script with a script command

PAM User record in the shared folder

AWS PAM Config

Attach PAM script with a script command

Attach Rotation Credentials to a PAM Script

![](https://docs.keeper.io/~gitbook/image?url=https%3A%2F%2F762006384-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-
x-
prod.appspot.com%2Fo%2Fspaces%252F-MJXOXEifAmpyvNVL1to%252Fuploads%252F8hGRGxseVFBkgBhCZgOL%252FPAM%2520User%2520Record.png%3Falt%3Dmedia%26token%3D67109c45-7c62-4509-88a2-43cff636410a&width=768&dpr=4&quality=100&sign=8f6e8abc&sv=2)

![](https://docs.keeper.io/~gitbook/image?url=https%3A%2F%2F762006384-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-
x-
prod.appspot.com%2Fo%2Fspaces%252F-MJXOXEifAmpyvNVL1to%252Fuploads%252FEzyW2H39WYUeA9VwuwrT%252FAWS%2520CreatePolicy.png%3Falt%3Dmedia%26token%3Df9165f46-f53f-4da9-b9ea-d031dca7a7aa&width=768&dpr=4&quality=100&sign=358d3a99&sv=2)

![](https://docs.keeper.io/~gitbook/image?url=https%3A%2F%2F762006384-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-
x-
prod.appspot.com%2Fo%2Fspaces%252F-MJXOXEifAmpyvNVL1to%252Fuploads%252F5KyHCeb2ORc1s5nY5Zst%252FAWS%2520CreateRole.png%3Falt%3Dmedia%26token%3D4aef00fe-b787-4841-910c-8852559277fe&width=768&dpr=4&quality=100&sign=a79e1145&sv=2)

![](https://docs.keeper.io/~gitbook/image?url=https%3A%2F%2F762006384-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-
x-
prod.appspot.com%2Fo%2Fspaces%252F-MJXOXEifAmpyvNVL1to%252Fuploads%252FVWsI0dcG521BnMr6FKEF%252FAWS%2520CreateRole2.png%3Falt%3Dmedia%26token%3D15d34af6-92bb-4931-8b1f-4515c70bbcd3&width=768&dpr=4&quality=100&sign=547c636&sv=2)

![](https://docs.keeper.io/~gitbook/image?url=https%3A%2F%2F762006384-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-
x-
prod.appspot.com%2Fo%2Fspaces%252F-MJXOXEifAmpyvNVL1to%252Fuploads%252FNHXpV8sJURdL9cwRiSLs%252FAWS%2520EC2AssignRole.png%3Falt%3Dmedia%26token%3D8e1d15d9-61b0-4476-8833-886da84f5915&width=768&dpr=4&quality=100&sign=ffba7a5&sv=2)

![](https://docs.keeper.io/~gitbook/image?url=https%3A%2F%2F762006384-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-
x-
prod.appspot.com%2Fo%2Fspaces%252F-MJXOXEifAmpyvNVL1to%252Fuploads%252FF1VINzKKdSNdsLoZNe16%252FAWS%2520EC2AssignRole2.png%3Falt%3Dmedia%26token%3D0e352ddc-56dd-4e8e-82ae-
be89c5235138&width=768&dpr=4&quality=100&sign=d36fb691&sv=2)

![](https://docs.keeper.io/~gitbook/image?url=https%3A%2F%2F762006384-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-
x-
prod.appspot.com%2Fo%2Fspaces%252F-MJXOXEifAmpyvNVL1to%252Fuploads%252FHtbVyJz1IXR26TxLHoQw%252FPAMConfig%2520LocalNetwork.png%3Falt%3Dmedia%26token%3D88aba039-9ebe-452b-9b96-19a2619aae90&width=768&dpr=4&quality=100&sign=42614ad9&sv=2)

![](https://docs.keeper.io/~gitbook/image?url=https%3A%2F%2F762006384-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-
x-
prod.appspot.com%2Fo%2Fspaces%252F-MJXOXEifAmpyvNVL1to%252Fuploads%252FqXZnrLkNJ89I4bU1hie5%252FPAMUser%2520Add%2520PAM%2520Script.png%3Falt%3Dmedia%26token%3Dc75afd26-57e9-4340-9376-ada1f141fc97&width=768&dpr=4&quality=100&sign=8a8c4a27&sv=2)

![](https://docs.keeper.io/~gitbook/image?url=https%3A%2F%2F762006384-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-
x-
prod.appspot.com%2Fo%2Fspaces%252F-MJXOXEifAmpyvNVL1to%252Fuploads%252FfvP0GEWBOrQVscGkZqKn%252FKeeperVault%2520-%2520Folder%2520and%2520record.png%3Falt%3Dmedia%26token%3Df091fe17-5e6f-4133-bfe9-dab8c9b3d7af&width=768&dpr=4&quality=100&sign=f1fdb9bc&sv=2)

![](https://docs.keeper.io/~gitbook/image?url=https%3A%2F%2F762006384-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-
x-
prod.appspot.com%2Fo%2Fspaces%252F-MJXOXEifAmpyvNVL1to%252Fuploads%252FwmTsOCAsedbfpJIbtRXH%252FPAMConfig%2520AWS.png%3Falt%3Dmedia%26token%3De56ca8f9-dd24-43a5-8eec-c080c2ae9d49&width=768&dpr=4&quality=100&sign=4e6ab3da&sv=2)

![](https://docs.keeper.io/~gitbook/image?url=https%3A%2F%2F762006384-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-
x-
prod.appspot.com%2Fo%2Fspaces%252F-MJXOXEifAmpyvNVL1to%252Fuploads%252FqXZnrLkNJ89I4bU1hie5%252FPAMUser%2520Add%2520PAM%2520Script.png%3Falt%3Dmedia%26token%3Dc75afd26-57e9-4340-9376-ada1f141fc97&width=768&dpr=4&quality=100&sign=8a8c4a27&sv=2)

![](https://docs.keeper.io/~gitbook/image?url=https%3A%2F%2F762006384-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-
x-
prod.appspot.com%2Fo%2Fspaces%252F-MJXOXEifAmpyvNVL1to%252Fuploads%252F3b7fmhvsw0nsNosFoITg%252FPAMUser%2520Add%2520PAM%2520Script%2520with%2520Cred.png%3Falt%3Dmedia%26token%3D17fa272f-155f-47e1-9bf3-5417440f2fe6&width=768&dpr=4&quality=100&sign=8e457299&sv=2)

